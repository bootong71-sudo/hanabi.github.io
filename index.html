<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>花火シミュレーション（F1：設定文字が暗くなります）</title>
<style>
  body { margin:0; background:black; font-family:sans-serif; }
  canvas{display:block;}

  .controls {
    position: fixed; top:10px; left:10px;
    background: rgba(0,0,0,0.4);
    padding:8px; border-radius:6px; max-width:300px;
    font-size:12px; color: rgba(255,255,255,0.7);
    transition: opacity 0.3s;
  }
  .controls.hidden {
    opacity:0.2;
    pointer-events:none;
  }
  .controls h4 { font-size:13px; margin:5px 0; color: rgba(255,255,255,0.8);}
  .controls label { display:block; margin:3px 0;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="controls">
  <h4>通常花火</h4>
  <label>粒の数: <span id="countVal">50</span>
    <input type="range" id="particleCount" min="10" max="200" value="50">
  </label>
  <label>速度: <span id="speedVal">1</span>
    <input type="range" id="particleSpeed" min="0.5" max="5" step="0.1" value="1">
  </label>

  <h4>特大花火</h4>
  <label>粒の数: <span id="bigCountVal">300</span>
    <input type="range" id="bigParticleCount" min="50" max="500" value="300">
  </label>
  <label>サイズ: <span id="bigSizeVal">12</span>
    <input type="range" id="bigParticleSize" min="5" max="30" value="12">
  </label>
  <label>速度: <span id="bigSpeedVal">2</span>
    <input type="range" id="bigParticleSpeed" min="0.5" max="5" step="0.1" value="2">
  </label>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

// 効果音
const launchSound = new Audio('launch.mp3');
const explodeSound = new Audio('explode.mp3');
const boomSound = new Audio('boom.mp3');

// スライダー
const particleCountSlider=document.getElementById('particleCount');
const particleSpeedSlider=document.getElementById('particleSpeed');
const countVal=document.getElementById('countVal');
const speedVal=document.getElementById('speedVal');

const bigParticleCountSlider=document.getElementById('bigParticleCount');
const bigParticleSizeSlider=document.getElementById('bigParticleSize');
const bigParticleSpeedSlider=document.getElementById('bigParticleSpeed');
const bigCountVal=document.getElementById('bigCountVal');
const bigSizeVal=document.getElementById('bigSizeVal');
const bigSpeedVal=document.getElementById('bigSpeedVal');

particleCountSlider.addEventListener('input',()=>countVal.textContent=particleCountSlider.value);
particleSpeedSlider.addEventListener('input',()=>speedVal.textContent=particleSpeedSlider.value);
bigParticleCountSlider.addEventListener('input',()=>bigCountVal.textContent=bigParticleCountSlider.value);
bigParticleSizeSlider.addEventListener('input',()=>bigSizeVal.textContent=bigParticleSizeSlider.value);
bigParticleSpeedSlider.addEventListener('input',()=>bigSpeedVal.textContent=bigParticleSpeedSlider.value);

// パーティクル
class Particle{
  constructor(x,y,color,size=3,speedMultiplier=1,vyMult=1,isNiagara=false){
    this.x=x; this.y=y;
    const angle=Math.random()*2*Math.PI;
    const speed=(Math.random()*5+2)*speedMultiplier;
    this.vx=Math.cos(angle)*speed;
    this.vy=Math.sin(angle)*speed*vyMult;
    this.alpha=1;
    this.color=color;
    this.size=size;
    this.isNiagara=isNiagara;
    this.life=isNiagara? 120 : 50;
  }
  update(){ 
    this.x+=this.vx; 
    this.y+=this.vy; 
    if(!this.isNiagara) this.vy+=0.05; 
    this.alpha = this.life / (this.isNiagara? 120 : 50);
    this.life--;
  }
  draw(){ 
    ctx.globalAlpha=this.alpha; 
    ctx.fillStyle=this.color; 
    ctx.beginPath(); 
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2); 
    ctx.fill(); 
    ctx.globalAlpha=1; 
  }
}

// 花火
class Firework{
  constructor(isBig=false, isNiagara=false, startX=null, targetY=null){
    this.isBig=isBig; this.isNiagara=isNiagara;
    if(isNiagara){ 
      this.x = startX ?? Math.random()*canvas.width; 
      this.targetY = canvas.height; 
    }
    else if(isBig){ 
      this.x = startX ?? canvas.width/2; 
      this.targetY = targetY ?? canvas.height/3; 
    }
    else { 
      this.x = startX ?? Math.random()*canvas.width; 
      this.targetY = targetY ?? Math.random()*canvas.height/2; 
    }
    this.y=canvas.height;
    this.exploded=false; this.particles=[]; this.launched=false;
  }

  update(){
    if(!this.exploded){
      if(!this.isNiagara) this.y-=7;
      if(!this.launched){ launchSound.currentTime=0; launchSound.play(); this.launched=true; }
      if((this.isNiagara && Math.random()<0.02) || this.y<=this.targetY){
        this.exploded=true;
        if(this.isNiagara) { boomSound.currentTime=0; boomSound.play(); flashScreen(); }
        else explodeSound.currentTime=0, explodeSound.play();

        let count,size,speedMultiplier,vyMult=1;
        if(this.isNiagara){ 
          count=150; size=5; speedMultiplier=1; vyMult=3; 
          for(let i=0;i<count;i++){
            const color=`hsl(${Math.random()*50+40},100%,60%)`; 
            this.particles.push(new Particle(this.x,this.y,color,size,speedMultiplier,vyMult,true));
          }
        }
        else if(this.isBig){ 
          count=parseInt(bigParticleCountSlider.value); 
          size=parseInt(bigParticleSizeSlider.value); 
          speedMultiplier=parseFloat(bigParticleSpeedSlider.value); 
          for(let i=0;i<count;i++){
            const color=`hsl(${Math.random()*360},100%,50%)`;
            this.particles.push(new Particle(this.x,this.y,color,size,speedMultiplier,vyMult));
          }
        }
        else{ 
          count=parseInt(particleCountSlider.value); 
          speedMultiplier=parseFloat(particleSpeedSlider.value);
          for(let i=0;i<count;i++){
            size=2+Math.random()*6;
            const color=`hsl(${Math.random()*360},100%,50%)`;
            this.particles.push(new Particle(this.x,this.y,color,size,speedMultiplier,vyMult));
          }
        }
      }
    }else{ 
      this.particles.forEach(p=>p.update()); 
      this.particles=this.particles.filter(p=>p.alpha>0); 
    }
  }

  draw(){ 
    if(!this.exploded){ 
      ctx.fillStyle="white"; 
      ctx.beginPath(); 
      ctx.arc(this.x,this.y,this.isBig?parseInt(bigParticleSizeSlider.value)*1.5:3,0,Math.PI*2); 
      ctx.fill(); 
    } else{ 
      this.particles.forEach(p=>p.draw()); 
    } 
  }
}

// フラッシュ効果
let flashAlpha=0, flashTarget=0, flashProgress=0;
let flashSpeed=0.05;

function flashScreen(){
  flashTarget=0.1;
  flashProgress=0;
}

// アニメーション
let fireworks=[]; 
let lastFireTime=0; 
const fireDelay=200; 
let fireCount=0;

document.addEventListener("keydown", (e)=>{
  const now=Date.now();
  if(e.key==="F1"){
    e.preventDefault();
    document.querySelector(".controls").classList.toggle("hidden");
    return;
  }
  if(now-lastFireTime>=fireDelay){
    fireCount++;
    if(fireCount%30===0){ for(let i=0;i<30;i++)fireworks.push(new Firework(false,true)); }
    else fireworks.push(new Firework(fireCount%10===0));
    lastFireTime=now;
  }
});

// ★ クリックで花火発射（クリック位置から）★
canvas.addEventListener("click",(e)=>{
  const now=Date.now();
  if(now-lastFireTime>=fireDelay){
    fireCount++;
    const rect=canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    if(fireCount%30===0){ for(let i=0;i<30;i++)fireworks.push(new Firework(false,true, clickX)); }
    else fireworks.push(new Firework(fireCount%10===0, false, clickX, clickY));
    lastFireTime=now;
  }
});

function animate(){
  ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fillRect(0,0,canvas.width,canvas.height);

  fireworks.forEach(fw=>{ fw.update(); fw.draw(); });
  fireworks=fireworks.filter(fw=>!fw.exploded||fw.particles.length>0);

  // フラッシュアニメーション
  if(flashProgress<1){
    flashProgress += flashSpeed;
    flashAlpha = flashTarget * flashProgress;
  } else if(flashAlpha>0){
    flashAlpha -= flashSpeed/2;
    if(flashAlpha<0) flashAlpha=0;
  }

  if(flashAlpha>0){
    ctx.fillStyle=`rgba(255,200,100,${flashAlpha})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
